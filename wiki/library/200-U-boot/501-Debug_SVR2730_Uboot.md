<!-- TOC depthFrom:0 depthTo:4 withLinks:1 updateOnSave:1 orderedList:1 -->
# svr2730 uboot debug 日志
>1. [前提](#前提 "前提")
1. [用HiTool烧u-boot](#用HiTool烧u-boot "用HiTool烧u-boot")
1. [u-boot功能验证](#u-boot功能验证 "u-boot功能验证")
	1. [DDR验证](#DDR验证 "DDR验证")
	1. [Flash验证](#Flash验证 "Flash验证")
	1. [串口验证](#串口验证 "串口验证")
	1. [网络验证](#网络验证 "网络验证")
	1. [I2C驱动支持验证](#I2C驱动支持验证 "I2C驱动支持验证")
	1. [FPGA firmware 加载验证](#FPGA firmware 加载验证 "FPGA firmware 加载验证")
	1. [ZL20367时钟芯片配置验证](#ZL20367时钟芯片配置验证 "ZL20367时钟芯片配置验证")
1. [小结](#小结 "小结")
<!-- /TOC -->

# svr2730 uboot debug 日志

## 前提

3536的启动模式需要设置成从BOOTROM启动，BOOTROM_SEL=1，并且设置BOOT_SEL0=0，BOOT_SEL1=0，表示当BOOTROM与串口的通信超时后将会从SPI nor flash启动。

![启动模式](assets/200/501-6f72422a.png)

![启动模式说明](assets/200/501-39c5786b.png)

拿到板子最初始状态应该是：板子上没有任何程序，接上3536的UART0调试串口（波特率默认115200）后会有空格打印。此时认为CPU的供电，基本时钟都正常，上电可以进入到BOOTROM建立串口通信，这样就可以用Hitool烧程序到板子的flash上了。

## 用HiTool烧u-boot

打开HiTool工具

1. 确认选择的是3536芯片
2. 选择传输方式为串口
3. 选择正确的串口号，一定要主要选对
4. 切换到烧写fastboot选项卡
5. flash类型选择 spi
6. 浏览选择u-boot镜像
7. 文件列表会显示选择的u-boot镜像路径
8. 先把设备断电，点击 **烧写** 按钮，在15秒内给设备上电，烧写一般就是成功了，如果不成功请检查 **前提** 条件。

![Hitool烧写u-boot配置](assets/200/501-40e8d096.png)

如果 **前提** 条件都符合，还是烧不进去，那么还可以再是一个方法：把BOOTROM_SEL悬空（在svr2930上是要这样才行的），原因待查。

以上都做了还是烧不进去的话再查吧，目前还没有遇到更多问题。

## u-boot功能验证

### DDR验证

DDR芯片：4片H5TQ4G63CFR-RDC 合计2GB

时序配置需要学习使用hisi提供的表格文件来生成时序配置bin。具体怎么用有待学习。

这个东西是必须第一时间保证没问题的，但是现在SVR2730和SVR2930上用的都是成熟的方案，没有问题，也就没有研究。完全不知道该怎么搞。

如果DDR有问题的话，时序是肯定要检查的。

具体的以后在详谈。

### Flash验证

Flash芯片：2片MX25L25635FMI-10G 合计64MB

用的也是典型设计，并没有问题，主要就是调整一下分区结构，因为u-boot里面添加了Fpga、I2C、ZL30267这些代码，导致u-boot的大小超过了256KB,所以需要调整u-boot分区空间到512KB。

可能会遇到的问题：

	1、u-boot镜像大小超过uboot分区大小，这样通过HiTool是能够烧写进去的，但是这样会导致每次都把env的配置覆盖，而且一旦执行save命令保存env后u-boot就会出现一下奇怪的问题。所以要注意调整uboot分区大小到可以容纳uboot镜像；
	2、如果使用了新的flash芯片，需要注意flash驱动是否支持。
	3、ios 分区大小也要注意调整。

其他还有问题的话请查阅 **U-boot下his3536_sfc350_SPI_norflash驱动**

### 串口验证

这个说起来是不会有问题，如果有问题请查阅 **U-boot下的串口驱动支持**

### 网络验证

SVR2730的Port0连接RTL8211E-VB-CG用作千兆网口，Port1连接88E6097-XX-TAH1C000交换机芯片扩展成6个百兆网口，其中4个支持POE功能。

### I2C驱动支持验证

需要用到i2c命令组件，然而我并不会用。

I2C控制器驱动必须要每次都检查读写是否成功，在读写逻辑的最后添加等待I2C变成IDEL状态，否则本次的错误传输状态会体现在下次的传输上，导致问题定位不准确。

### FPGA firmware 加载验证

1. 通过FPGA的GPIO加载
2. 通过I2C读0x0寄存器获得ver
3. 写0x1寄存器再读出来验证写功能

### ZL20367时钟芯片配置验证

1. 用ZL20367提供的配置软件生成寄存器配置时序表
2. 把时序表制作成数组
3. 依次写入就完事了


## 小结

东西不多，但是调试起来会遇到很多问题，主要还是要细心，避免马虎带来不必要的问题。
